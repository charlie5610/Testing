<!doctype html>
<html>
    <head>
        <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
        <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
    </head>

    <body style="margin: 0; overflow: hidden;">
        <div align="center" style='position: fixed; top: 10px; width:100%; text-align: right; z-index: 1;right:15px'>
            <input type=button id="Start" value="Start" onclick="Rotation1()"/>
            <input type=button id="Left" value="Turn Left" />
            <input type=button id="Right" value="Turn Right"/>
        </div>
        <div align="center" style='position: fixed; top: 35px; width:100%; text-align: right; z-index: 1;right:15px'>
            <span rows="1" cols="15">Timer: </span><span id="Timer">00:00&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp</span>
        </div>
        <a-scene
            vr-mode-ui="enabled: false;"
            loading-screen="enabled: false;"
            renderer="logarithmicDepthBuffer: true;"
            arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
            id="scene"
            embedded
            gesture-detector
        >
            <a-assets>
                <a-asset-item
                    id="animated-asset"
                    src="assets/asset.glb"
                ></a-asset-item>
            </a-assets>

            <a-marker
                id="animated-marker"
                type="pattern"
                preset="custom"
                url="assets/marker.patt"
                raycaster="objects: .clickable"
                emitevents="true"
                cursor="fuse: false; rayOrigin: mouse;"
                id="markerA"
            >
                <a-entity
                    id="bowser-model"
                    scale="0.005 0.005 0.005"
                    animation-mixer="loop: repeat"
                    gltf-model="#animated-asset"
                    class="clickable"
                    gesture-handler
                ></a-entity>
            </a-marker>

            <a-entity camera></a-entity>
        </a-scene>
        <script type="text/javascript">
            gltf = document.querySelector('#bowser-model')
            scene1 = document.querySelector('a-scene');
            const scene = new THREE.Scene();
            inputSpeed = prompt("Please enter your theoretical velocity(m/s):");
            factor =2.2;
            Turn = null;
            straight = null;  
            document.getElementById("Left").disabled=true;
            document.getElementById("Right").disabled=true;
//            inputSpeed = -0.5;
            Lvec = new THREE.Vector3( 1, 0, 0 );
            point = new THREE.Vector3();
            function leftGearBox(){
                RIGHTassem.children[103].rotateX(factor*-inputSpeed)
                RIGHTassem.children[96].rotateY(factor*inputSpeed/50)
                RIGHTassem.children[97].rotateY(factor*-inputSpeed/100)
            }
            function rightGearBox(){
                RIGHTassem.children[104].rotateX(factor*-inputSpeed)                
                RIGHTassem.children[79].rotateY(factor*inputSpeed/50)                 
                RIGHTassem.children[78].rotateY(factor*-inputSpeed/100)
                RIGHTassem.children[98].rotateY(factor*-inputSpeed/100)
                
            }
            function Time(){
                today = new Date();
                todayTime = today - initialTime;
                counters = todayTime*0.001 - 60*Math.floor(todayTime*0.001/60);
                counterms = 1;
                document.getElementById("Timer").innerHTML = Math.floor(counters).toFixed(0) +":"+counterms
            }
            function Rotation(){                
                leftGearBox();
                rightGearBox();
                mesh.translateOnAxis(Lvec,100*inputSpeed)
            }            
            function RotateLeft(){
                LEFTAssen.attach(RIGHTassem)
                LEFTAssen.rotateY(inputSpeed/5)
                Lvec.applyAxisAngle(new THREE.Vector3(0,1,0),inputSpeed/5)
                rightGearBox();
            }
            function RotateRight(){
                RIGHTassem.attach(LEFTAssen)
                RIGHTassem.rotateY(-inputSpeed/5)
                Lvec.applyAxisAngle(new THREE.Vector3(0,1,0),-inputSpeed/5)            
                leftGearBox();                
            }            
            function Left(){
                clearInterval(straight)
                straight = null;
                if(Turn==null){
                Turn = setInterval(RotateLeft,20)}
            }
            function Right(){
                clearInterval(straight)
                straight =null;
                if(Turn==null){
                Turn = setInterval(RotateRight,20)}
            }
            function Rotation1(){
                if(Turn!=null && straight==null){
                    if(Turn!=null){
                    clearInterval(Turn)
                    Turn=null;}
                    mesh.attach(RIGHTassem)
                    mesh.attach(LEFTAssen)
                    straight = setInterval(Rotation,10)
                }else{
                    document.getElementById("Start").remove();
                    straight = window.setInterval(Rotation,10)
                    document.getElementById("Left").disabled=false;
                    document.getElementById("Right").disabled=false;
//                    initialTime = new Date();
//                    t = setInterval(Time,1000)
                }
            }            
            scene1.addEventListener('loaded', function (e) {
                mesh = gltf.getObject3D('mesh');
                LEFTAssen = mesh.children[1]
                RIGHTassem = mesh.children[0]
            });
                document.getElementById('Left').addEventListener('mousedown',Left)
                document.getElementById('Left').addEventListener('mouseup',Rotation1)
                document.getElementById('Right').addEventListener('mousedown',Right)
                document.getElementById('Right').addEventListener('mouseup',Rotation1)
        </script>
        <style type="text/css">
            .wrap {
                display: inline;
            }

            .wrap span {
                position: absolute;
                top: 0;
                right: 0;
            }
            textarea{
                resize: none;
            }
        </style>
    </body>
</html>
